import { NextRequest, NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';

// Initialize Gemini
const genAI = new GoogleGenerativeAI(process.env.GEMINI_KEY || '');

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}

interface ContextItem {
  text: string;
  page: number;
}

interface ReaderAIRequest {
  message: string;
  contextItems: ContextItem[];
  currentPage: number;
  chapterTitle: string;
  chapterId: string;
  bookId: string;
  pageText?: string; // Text extracted from current PDF page
  chatHistory?: ChatMessage[];
}

// Page-specific content knowledge base
const pageKnowledge: Record<string, Record<number, string>> = {
  'ch1': {
    1: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ßß - ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡¶∞ ‡¶ì ‡¶ï‡ßç‡¶∞‡¶Æ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂:
‚Ä¢ ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ú‡ßç‡¶û‡¶æ: ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•, ‡¶∂‡¶ï‡ßç‡¶§‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡¶ï‡¶æ‡¶∞ ‡¶Æ‡¶ø‡¶•‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶Ø‡¶º‡¶®
‚Ä¢ ‡¶™‡¶∞‡¶ø‡¶∏‡¶∞: ‡¶ï‡ßç‡¶∑‡ßÅ‡¶¶‡ßç‡¶∞‡¶§‡¶Æ ‡¶ï‡¶£‡¶æ (‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®, ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡¶®) ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßÉ‡¶π‡¶§‡ßç‡¶§‡¶Æ ‡¶Æ‡¶π‡¶æ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨
‚Ä¢ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ: ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤, ‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶®‡ßç‡¶ü‡¶æ‡¶Æ, ‡¶Ü‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶ø‡¶ï‡¶§‡¶æ ‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨
‚Ä¢ ‡¶Ü‡¶®‡ßç‡¶§‡¶É‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞: ‡¶ú‡ßç‡¶Ø‡ßã‡¶§‡¶ø‡¶É‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®, ‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®`,
    2: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß® - ‡¶≠‡ßå‡¶§ ‡¶∞‡¶æ‡¶∂‡¶ø ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™:
‚Ä¢ ‡¶≠‡ßå‡¶§ ‡¶∞‡¶æ‡¶∂‡¶ø: ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶∞‡¶æ‡¶∂‡¶ø ‡¶Ø‡¶æ ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º
‚Ä¢ ‡¶¨‡ßà‡¶∂‡¶ø‡¶∑‡ßç‡¶ü‡ßç‡¶Ø: ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø, ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø, ‡¶è‡¶ï‡¶ï ‡¶Ü‡¶õ‡ßá, ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø
‚Ä¢ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: ‡¶¶‡ßà‡¶∞‡ßç‡¶ò‡ßç‡¶Ø (‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞), ‡¶≠‡¶∞ (‡¶ï‡¶ø‡¶≤‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ), ‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°), ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ (‡¶ï‡ßá‡¶≤‡¶≠‡¶ø‡¶®)`,
    3: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß© - SI ‡¶è‡¶ï‡¶ï ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø:
‚Ä¢ SI ‡¶è‡¶ï‡¶ï: ‡¶Ü‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶ú‡¶æ‡¶§‡¶ø‡¶ï ‡¶è‡¶ï‡¶ï ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø
‚Ä¢ ‡¶Æ‡ßå‡¶≤‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶¨‡ßç‡¶ß ‡¶è‡¶ï‡¶ï
‚Ä¢ ‡¶è‡¶ï‡¶ï‡ßá‡¶∞ ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£`,
    4: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß™ - ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™‡ßá‡¶∞ ‡¶Ø‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶™‡¶æ‡¶§‡¶ø:
‚Ä¢ ‡¶∏‡ßç‡¶ï‡ßá‡¶≤ - ‡¶¶‡ßà‡¶∞‡ßç‡¶ò‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™
‚Ä¢ ‡¶•‡¶æ‡¶∞‡ßç‡¶Æ‡ßã‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ - ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™
‚Ä¢ ‡¶∏‡ßç‡¶ü‡¶™‡¶ì‡¶Ø‡¶º‡¶æ‡¶ö - ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™
‚Ä¢ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ - ‡¶≠‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™
‚Ä¢ ‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ - ‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™`,
    5: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß´ - ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤‡¶§‡¶æ ‡¶ì ‡¶Ø‡¶•‡¶æ‡¶∞‡ßç‡¶•‡¶§‡¶æ:
‚Ä¢ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤‡¶§‡¶æ: ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™‡ßá ‡¶ï‡¶§‡¶ü‡¶æ ‡¶ï‡¶æ‡¶õ‡¶æ‡¶ï‡¶æ‡¶õ‡¶ø ‡¶´‡¶≤ ‡¶Ü‡¶∏‡ßá
‚Ä¢ ‡¶Ø‡¶•‡¶æ‡¶∞‡ßç‡¶•‡¶§‡¶æ: ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Æ‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶§‡¶ü‡¶æ ‡¶ï‡¶æ‡¶õ‡ßá`,
  },
  'ch2': {
    1: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ßß - ‡¶ó‡¶§‡¶ø‡¶∞ ‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶æ:
‚Ä¢ ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø: ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶∏‡ßç‡¶•‡¶ø‡¶∞, ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º ‡¶®‡¶æ
‚Ä¢ ‡¶ó‡¶§‡¶ø: ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®, ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º
‚Ä¢ ‡¶¨‡¶≤‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡ßå‡¶≤‡¶ø‡¶ï ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ`,
    2: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß® - ‡¶™‡¶∞‡¶∏‡¶ô‡ßç‡¶ó ‡¶ï‡¶æ‡¶†‡¶æ‡¶Æ‡ßã:
‚Ä¢ ‡¶™‡¶∞‡¶∏‡¶ô‡ßç‡¶ó ‡¶ï‡¶æ‡¶†‡¶æ‡¶Æ‡ßã: ‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßá‡¶ï‡ßç‡¶∑‡ßá ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®, ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø, ‡¶ó‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶£‡¶Ø‡¶º ‡¶ï‡¶∞‡¶ø
‚Ä¢ ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶ì ‡¶ó‡¶§‡¶ø ‡¶Ü‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶ø‡¶ï
‚Ä¢ ‡¶Æ‡¶π‡¶æ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶á ‡¶Ü‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶ø‡¶ï, ‡¶∏‡¶ï‡¶≤ ‡¶ó‡¶§‡¶ø‡¶á ‡¶Ü‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶ø‡¶ï`,
    3: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß© - ‡¶ó‡¶§‡¶ø‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞‡¶≠‡ßá‡¶¶:
‚Ä¢ ‡¶∞‡ßà‡¶ñ‡¶ø‡¶ï ‡¶ó‡¶§‡¶ø: ‡¶∏‡¶∞‡¶≤‡¶∞‡ßá‡¶ñ‡¶æ‡¶Ø‡¶º ‡¶ö‡¶≤‡ßá
‚Ä¢ ‡¶ò‡ßÇ‡¶∞‡ßç‡¶£‡¶® ‡¶ó‡¶§‡¶ø: ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶ö‡¶æ‡¶∞‡¶™‡¶æ‡¶∂‡ßá ‡¶ò‡ßã‡¶∞‡ßá
‚Ä¢ ‡¶ö‡¶≤‡¶® ‡¶ó‡¶§‡¶ø: ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶£‡¶æ ‡¶è‡¶ï‡¶á ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ö‡¶≤‡ßá
‚Ä¢ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶¨‡ßÉ‡¶§‡ßç‡¶§ ‡¶ó‡¶§‡¶ø: ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶è‡¶ï‡¶á ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡ßá`,
    4: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß™ - ‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡¶æ‡¶∞ ‡¶ì ‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞:
‚Ä¢ ‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶∂‡¶ø: ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶õ‡ßá, ‡¶¶‡¶ø‡¶ï ‡¶®‡ßá‡¶á (‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨, ‡¶∏‡¶Æ‡¶Ø‡¶º, ‡¶∂‡¶ï‡ßç‡¶§‡¶ø)
‚Ä¢ ‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞ ‡¶∞‡¶æ‡¶∂‡¶ø: ‡¶Æ‡¶æ‡¶® ‡¶ì ‡¶¶‡¶ø‡¶ï ‡¶â‡¶≠‡¶Ø‡¶º‡¶á ‡¶Ü‡¶õ‡ßá (‡¶∏‡¶∞‡¶£, ‡¶¨‡ßá‡¶ó, ‡¶¨‡¶≤)`,
    5: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß´ - ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ ‡¶ì ‡¶∏‡¶∞‡¶£:
‚Ä¢ ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨: ‡¶Æ‡ßã‡¶ü ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ ‡¶™‡¶• (‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡¶æ‡¶∞)
‚Ä¢ ‡¶∏‡¶∞‡¶£: ‡¶Ü‡¶¶‡¶ø ‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶∞‡¶≤‡¶∞‡ßà‡¶ñ‡¶ø‡¶ï ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ (‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞)
‚Ä¢ ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶•‡ßá ‡¶ò‡ßÅ‡¶∞‡ßá ‡¶Ü‡¶∏‡¶≤‡ßá ‡¶∏‡¶∞‡¶£ ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø`,
    6: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß¨ - ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø:
‚Ä¢ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø: ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞
‚Ä¢ ‡¶ó‡¶°‡¶º ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø = ‡¶Æ‡ßã‡¶ü ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ / ‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º
‚Ä¢ ‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø: ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø`,
    7: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ß≠ - ‡¶¨‡ßá‡¶ó:
‚Ä¢ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø: ‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶∂‡¶ø (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶®)
‚Ä¢ ‡¶¨‡ßá‡¶ó: ‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞ ‡¶∞‡¶æ‡¶∂‡¶ø (‡¶Æ‡¶æ‡¶® ‡¶ì ‡¶¶‡¶ø‡¶ï)
‚Ä¢ ‡¶∏‡ßÅ‡¶∑‡¶Æ ‡¶¨‡ßá‡¶ó: ‡¶Æ‡¶æ‡¶® ‡¶ì ‡¶¶‡¶ø‡¶ï ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§
‚Ä¢ ‡¶Ö‡¶∏‡ßÅ‡¶∑‡¶Æ ‡¶¨‡ßá‡¶ó: ‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ ‡¶¶‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º`,
    8: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ßÆ - ‡¶§‡ßç‡¶¨‡¶∞‡¶£ ‡¶ì ‡¶Æ‡¶®‡ßç‡¶¶‡¶®:
‚Ä¢ ‡¶§‡ßç‡¶¨‡¶∞‡¶£: ‡¶¨‡ßá‡¶ó ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø‡¶∞ ‡¶π‡¶æ‡¶∞, a = (v-u)/t
‚Ä¢ ‡¶Æ‡¶®‡ßç‡¶¶‡¶®: ‡¶¨‡ßá‡¶ó ‡¶π‡ßç‡¶∞‡¶æ‡¶∏‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞ (‡¶ã‡¶£‡¶æ‡¶§‡ßç‡¶Æ‡¶ï ‡¶§‡ßç‡¶¨‡¶∞‡¶£)
‚Ä¢ ‡¶∏‡ßÅ‡¶∑‡¶Æ ‡¶§‡ßç‡¶¨‡¶∞‡¶£: ‡¶¨‡ßá‡¶ó ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø‡¶∞ ‡¶π‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶®
‚Ä¢ ‡¶Ö‡¶∏‡¶Æ ‡¶§‡ßç‡¶¨‡¶∞‡¶£: ‡¶¨‡ßá‡¶ó ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø‡¶∞ ‡¶π‡¶æ‡¶∞ ‡¶Ö‡¶∏‡¶Æ‡¶æ‡¶®`,
    9: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ßØ - ‡¶™‡¶°‡¶º‡¶®‡ßç‡¶§ ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶ì ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑:
‚Ä¢ ‡¶Æ‡¶π‡¶æ‡¶ï‡¶∞‡ßç‡¶∑: ‡¶Æ‡¶π‡¶æ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡ßá ‡¶¶‡ßÅ‡¶á ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ‡¶∞ ‡¶Ü‡¶ï‡¶∞‡ßç‡¶∑‡¶£
‚Ä¢ ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑: ‡¶™‡ßÉ‡¶•‡¶ø‡¶¨‡ßÄ ‡¶ì ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ‡¶∞ ‡¶Ü‡¶ï‡¶∞‡ßç‡¶∑‡¶£
‚Ä¢ ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑‡¶ú ‡¶§‡ßç‡¶¨‡¶∞‡¶£: g = GM/R¬≤`,
    10: `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡ßß‡ß¶ - ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶≤‡¶ø‡¶ì‡¶∞ ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞:
‚Ä¢ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞: ‡¶è‡¶ï‡¶á ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶°‡¶º‡¶®‡ßç‡¶§ ‡¶∏‡¶¨ ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶Æ‡¶æ‡¶ü‡¶ø‡¶§‡ßá ‡¶™‡ßå‡¶Å‡¶õ‡¶æ‡¶Ø‡¶º
‚Ä¢ ‡¶Æ‡ßá‡¶∞‡ßÅ ‡¶Ö‡¶û‡ßç‡¶ö‡¶≤‡ßá g ‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡ßá‡¶∂‡¶ø
‚Ä¢ ‡¶¨‡¶ø‡¶∑‡ßÅ‡¶¨‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶û‡ßç‡¶ö‡¶≤‡ßá g ‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶ï‡¶Æ`,
  }
};

// Build educational context based on chapter
function getChapterContext(chapterId: string, bookId: string): string {
  if (bookId === 'physics-9-10') {
    if (chapterId === 'ch1') {
      return `
‡¶è‡¶á ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: ‡¶≠‡ßå‡¶§ ‡¶∞‡¶æ‡¶∂‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™ (Chapter 1: Physical Quantities and Measurement)

‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶∏‡¶Æ‡ßÇ‡¶π:
- ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡¶∞ ‡¶ì ‡¶ï‡ßç‡¶∞‡¶Æ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂
- ‡¶≠‡ßå‡¶§ ‡¶∞‡¶æ‡¶∂‡¶ø (Physical Quantities): ‡¶Æ‡ßå‡¶≤‡¶ø‡¶ï ‡¶ì ‡¶≤‡¶¨‡ßç‡¶ß ‡¶∞‡¶æ‡¶∂‡¶ø
- ‡¶è‡¶ï‡¶ï (Units): SI ‡¶è‡¶ï‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ
- ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™ ‡¶Ø‡¶®‡ßç‡¶§‡ßç‡¶∞: ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶° ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶™‡¶æ‡¶∞‡ßç‡¶∏, ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßÅ ‡¶ó‡¶ú
- ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™‡ßá‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤‡¶§‡¶æ ‡¶ì ‡¶Ø‡¶•‡¶æ‡¶∞‡ßç‡¶•‡¶§‡¶æ
- ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£

‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞:
- ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßÄ‡¶ï‡¶∞‡¶£: [M^a L^b T^c]
- ‡¶∂‡¶§‡¶ï‡¶∞‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø = (‡¶™‡¶∞‡¶Æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø / ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Æ‡¶æ‡¶®) √ó ‡ßß‡ß¶‡ß¶%
`;
    } else if (chapterId === 'ch2') {
      return `
‡¶è‡¶á ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: ‡¶ó‡¶§‡¶ø (Chapter 2: Motion)

‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶∏‡¶Æ‡ßÇ‡¶π:
- ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶ì ‡¶ó‡¶§‡¶ø‡¶∞ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ
- ‡¶™‡¶∞‡¶∏‡¶ô‡ßç‡¶ó ‡¶ï‡¶æ‡¶†‡¶æ‡¶Æ‡ßã (Frame of Reference)
- ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ ‡¶ì ‡¶∏‡¶∞‡¶£ (Distance & Displacement)
- ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§‡¶ø ‡¶ì ‡¶¨‡ßá‡¶ó (Speed & Velocity)
- ‡¶§‡ßç‡¶¨‡¶∞‡¶£ ‡¶ì ‡¶Æ‡¶®‡ßç‡¶¶‡¶® (Acceleration & Deceleration)
- ‡¶∏‡¶Æ‡¶¨‡ßá‡¶ó ‡¶ì ‡¶Ö‡¶∏‡¶Æ‡¶¨‡ßá‡¶ó‡ßá ‡¶ó‡¶§‡¶ø
- ‡¶™‡¶°‡¶º‡¶®‡ßç‡¶§ ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ‡¶∞ ‡¶ó‡¶§‡¶ø ‡¶ì ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑‡¶ú ‡¶§‡ßç‡¶¨‡¶∞‡¶£

‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞:
- ‡¶¨‡ßá‡¶ó, v = s/t
- ‡¶§‡ßç‡¶¨‡¶∞‡¶£, a = (v-u)/t
- v = u + at
- s = ut + ¬Ωat¬≤
- v¬≤ = u¬≤ + 2as
- ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑‡¶ú ‡¶§‡ßç‡¶¨‡¶∞‡¶£, g ‚âà 9.8 m/s¬≤
`;
    }
  }

  return `‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø NCTB ‡¶™‡¶æ‡¶†‡ßç‡¶Ø‡¶™‡ßÅ‡¶∏‡ßç‡¶§‡¶ï‡ßá‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡•§`;
}

// Get page-specific knowledge
function getPageContext(chapterId: string, currentPage: number): string {
  const chapterData = pageKnowledge[chapterId];
  if (chapterData && chapterData[currentPage]) {
    return `\n\nüìñ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶¨‡¶∏‡ßç‡¶§‡ßÅ:\n${chapterData[currentPage]}`;
  }
  return '';
}

export async function POST(request: NextRequest) {
  try {
    const body: ReaderAIRequest = await request.json();
    const { message, contextItems, currentPage, chapterTitle, chapterId, bookId, pageText, chatHistory = [] } = body;

    if (!message) {
      return NextResponse.json({ error: 'Message is required' }, { status: 400 });
    }

    // Build the system prompt with educational context
    const chapterContext = getChapterContext(chapterId, bookId);
    const pageContext = getPageContext(chapterId, currentPage);

    // Build context from selected text
    let selectedTextContext = '';
    if (contextItems && contextItems.length > 0) {
      selectedTextContext = '\n\n‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶Ö‡¶Ç‡¶∂(‡¶ó‡ßÅ‡¶≤‡ßã) ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá:\n';
      contextItems.forEach((item) => {
        selectedTextContext += `\n[‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${item.page}]: "${item.text}"`;
      });
    }

    // Include PDF page text if provided
    let pdfTextContext = '';
    if (pageText && pageText.trim().length > 0) {
      // Limit to first 2000 characters to avoid token limits
      const truncatedText = pageText.trim().substring(0, 2000);
      pdfTextContext = `\n\nüìÑ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶™‡¶æ‡¶†‡ßç‡¶Ø:\n"${truncatedText}"`;
    }

    const systemPrompt = `# Reader AI - Shikkha AI Platform

‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶π‡¶≤‡ßá **Reader AI**, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º AI ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ **Shikkha AI** ‡¶è‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶§‡ßç‡¶Ø‡¶æ‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶™‡¶æ‡¶†‡ßç‡¶Ø ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ‡•§ ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßÄ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ (‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶§ ‡ßØ‡¶Æ-‡ßß‡ß¶‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø) ‡¶™‡¶°‡¶º‡¶æ‡¶∂‡ßã‡¶®‡¶æ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§

## üéØ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø
- ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶™‡¶æ‡¶†‡ßç‡¶Ø‡¶¨‡¶á ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ
- ‡¶ú‡¶ü‡¶ø‡¶≤ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶π‡¶ú ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ï‡¶∞‡¶æ
- ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π ‡¶¶‡ßÇ‡¶∞ ‡¶ï‡¶∞‡¶æ
- ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø‡¶§‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ï‡¶∞‡¶æ

## üìö ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶™‡¶ü
- **‡¶¨‡¶á:** ${bookId === 'physics-9-10' ? '‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® (‡ßØ‡¶Æ-‡ßß‡ß¶‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø) - NCTB' : bookId}
- **‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º:** ${chapterTitle}
- **‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ:** ${currentPage}

${chapterContext}
${pageContext}
${pdfTextContext}
${selectedTextContext}

## ‚úçÔ∏è ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ

### ‡¶≠‡¶æ‡¶∑‡¶æ ‡¶ì ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤:
1. **‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º** ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶æ‡¶ì (‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞)
2. ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶ì ‡¶¨‡ßã‡¶ß‡¶ó‡¶Æ‡ßç‡¶Ø‡¶§‡¶æ‡¶∞ ‡¶â‡¶™‡¶Ø‡ßã‡¶ó‡ßÄ **‡¶∏‡¶π‡¶ú ‡¶≠‡¶æ‡¶∑‡¶æ** ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞
3. ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ì ‡¶â‡ßé‡¶∏‡¶æ‡¶π‡¶¨‡ßç‡¶Ø‡¶û‡ßç‡¶ú‡¶ï ‡¶∏‡ßç‡¶¨‡¶∞‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤
4. ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò ‡¶â‡¶§‡ßç‡¶§‡¶∞‡ßá‡¶∞ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡ßá **‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü** ‡¶¨‡¶æ **‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ** ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞

### ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶¨‡¶∏‡ßç‡¶§‡ßÅ:
1. ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∂‡¶¨‡ßç‡¶¶ ‡¶¨‡¶æ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ **‡¶¨‡ßã‡¶≤‡ßç‡¶°** ‡¶ï‡¶∞‡ßá ‡¶≤‡ßá‡¶ñ
2. ‡¶ó‡¶æ‡¶£‡¶ø‡¶§‡¶ø‡¶ï **‡¶∏‡ßÇ‡¶§‡ßç‡¶∞** ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßá‡¶ñ (‡¶Ø‡ßá‡¶Æ‡¶®: v = u + at)
3. ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá **‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£** ‡¶¶‡¶æ‡¶ì
4. ‡¶Ø‡¶¶‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶∏‡ßá‡¶ü‡¶ø‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶æ‡¶ì
5. ‡¶≠‡ßÅ‡¶≤ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶® ‡¶ï‡¶∞ ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶®‡¶Æ‡ßç‡¶∞‡¶≠‡¶æ‡¶¨‡ßá

### ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶Ç:
- ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø **##** ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞
- ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø **‡¶¨‡ßã‡¶≤‡ßç‡¶°** ‡¶ï‡¶∞
- ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü (‚Ä¢) ‡¶¨‡¶æ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞
- ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≤‡ßá‡¶ñ

## üö´ ‡¶Ø‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ:
- ‡¶Ö‡¶∂‡ßç‡¶≤‡ßÄ‡¶≤ ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ
- ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶®‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø
- ‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
- ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá (‡¶Ø‡ßá‡¶Æ‡¶® ‡¶∞‡¶æ‡¶ú‡¶®‡ßÄ‡¶§‡¶ø) ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ

## ü§ñ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶Ø‡¶º:
- ‡¶§‡ßÅ‡¶Æ‡¶ø **Reader AI** - Shikkha AI ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶†‡ßç‡¶Ø ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ
- ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßá‡¶â ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßá "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø Gemini?", "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø ChatGPT?", "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡ßã‡¶® AI?" - ‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶≤ ‡¶§‡ßÅ‡¶Æ‡¶ø **Reader AI**, Shikkha AI ‡¶è‡¶∞ ‡¶™‡¶æ‡¶†‡ßç‡¶Ø ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ
- ‡¶§‡ßÅ‡¶Æ‡¶ø Gemini, ChatGPT, Claude ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã AI ‡¶®‡¶ì - ‡¶§‡ßÅ‡¶Æ‡¶ø Reader AI
- ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶Æ‡¶æ‡¶§‡¶æ ‡¶π‡¶≤‡ßã Shikkha AI ‡¶ü‡¶ø‡¶Æ

‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá: ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï, ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶∂‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ‡¶á ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú! üìñ‚ú®`;

    // Build conversation history for context
    const conversationHistory = chatHistory.map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }));

    // Initialize the model - using gemini-2.0-flash for higher rate limits
    const model = genAI.getGenerativeModel({
      model: 'gemini-2.0-flash',
      generationConfig: {
        temperature: 0.7,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 1024,
      },
    });

    // Start chat with history
    const chat = model.startChat({
      history: [
        {
          role: 'user',
          parts: [{ text: systemPrompt }]
        },
        {
          role: 'model',
          parts: [{ text: '‡¶Ü‡¶Æ‡¶ø **Reader AI**, Shikkha AI ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶†‡ßç‡¶Ø ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶è‡¶á ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶¨‡•§ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞! üìö' }]
        },
        ...conversationHistory
      ],
    });

    // Send the message
    const result = await chat.sendMessage(message);
    const response = await result.response;
    const text = response.text();

    return NextResponse.json({
      response: text,
      success: true
    });

  } catch (error: unknown) {
    // Log detailed error info
    console.error('Reader AI Error:', error);
    if (error instanceof Error) {
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
    }

    // Check if it's a Gemini API error
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';

    return NextResponse.json(
      {
        error: `AI ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${errorMessage}`,
        success: false
      },
    );
  }
}

